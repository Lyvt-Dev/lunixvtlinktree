<!DOCTYPE html>
<html lang="ko" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>인터넷 속도 테스트 – Calmly</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" crossorigin="anonymous" />
  <link rel="stylesheet" href="../assets/css/language-modal.css" />
  <link rel="stylesheet" href="../assets/css/settings.css" />
  <script src="https://cdn.jsdelivr.net/npm/tsparticles@2.11.1/tsparticles.bundle.min.js"></script>
  <link rel="stylesheet" href="../assets/css/speedtest.css" />
</head>
<body>
  <div id="settings-button" title="Settings">
    <i class="fas fa-cog"></i>
  </div>

  <!-- Background Music -->
  <audio id="background-music" loop>
    <source src="../assets/background.mp3" type="audio/mpeg">
  </audio>

  <div id="tsparticles"></div>

  <div class="container">
    <nav>
      <a href="index.html" class="fade-in" style="--delay: 0.1s">홈</a>
      <a href="gen.html" class="fade-in" style="--delay: 0.15s">비밀번호 생성기</a>
      <a href="speedtest.html" class="fade-in" style="--delay: 0.1s">속도 테스트</a>
      <a href="listanime.html" class="fade-in" style="--delay: 0.25s">애니메이션 목록</a>
    </nav>
    <header class="section">
      <h1 class="fade-in" style="--delay: 0.2s">
        <span style="--delay: 0.3s">⚡</span>
                <span style="--delay: 0.4s">인터넷 속도 테스트</span>
      </h1>
            <p class="fade-in" style="--delay: 0.5s">개인 정보 보호를 중시하는 인터넷 연결 테스트 <i class="fas fa-heart"></i>.</p>
    </header>
    <section class="section fade-in" style="--delay: 0.6s" id="results">
      <div class="stats">
                <div class="card"><span>핑</span><div class="stat-value" id="pingVal">–</div><span class="unit">ms</span></div>
                <div class="card"><span>다운로드</span><div class="stat-value" id="downVal">–</div><span class="unit">Mbps</span></div>
                <div class="card"><span>업로드</span><div class="stat-value" id="upVal">–</div><span class="unit">Mbps</span></div>
      </div>
            <button class="start-btn" id="startBtn" onclick="runSpeedTest()">테스트 시작</button>
    </section>
    <footer class="fade-in" style="--delay: 0.7s">
      <p>&copy; 2025 Luca. Made with <i class="fas fa-heart"></i> in Germany.</p>
            <p style="margin-top: 0.5rem;">방문자: <span id="visitor-count">...</span></p>
    </footer>
  </div>
  <script>

    fetch('https://api.visitors.watch/v1/hit/calmly-dev.xyz/visits')
      .then(response => response.json())
      .then(data => {
        document.getElementById('visitor-count').innerText = data.data.value;
      })
      .catch((error) => {
        console.error('Error fetching visitor count:', error);
        document.getElementById('visitor-count').innerText = 'N/A';
      });

    tsParticles.load("tsparticles", {
      background: { color: { value: "transparent" } },
      fpsLimit: 60,
      interactivity: { events: { onHover: { enable: true, mode: "grab" } }, modes: { grab: { distance: 180, links: { opacity: 0.8 } } } },
      particles: {
        color: { value: "#3b82f6" }, links: { enable: true, color: "#3b82f6", distance: 150, opacity: 0.35, width: 1 },
        move: { enable: true, speed: 1.5, outModes: { default: "out" }, random: true },
        number: { value: 60, density: { enable: true, area: 800 } },
        opacity: { value: 0.5 }, shape: { type: "circle" }, size: { value: { min: 1, max: 3 } },
      },
      detectRetina: true,
    });

    const pingEl = document.getElementById("pingVal");
    const downEl = document.getElementById("downVal");
    const upEl = document.getElementById("upVal");
    const startBtn = document.getElementById("startBtn");

    const DOWNLOAD_SIZES = [10e6, 25e6, 50e6, 100e6];
    const UPLOAD_SIZE = 64 * 1024; // 64KB

    async function runSpeedTest() {
      startBtn.disabled = true;
            startBtn.textContent = "테스트 중…";
      pingEl.textContent = downEl.textContent = upEl.textContent = "…";
      try {
        const ping = await measurePing('https://speed.cloudflare.com');
        pingEl.textContent = ping.toFixed(0);

        const download = await measureDownload(downEl);
        downEl.textContent = download.toFixed(1);

        const upload = await measureUpload(upEl);
        upEl.textContent = upload.toFixed(1);
      } catch (err) {
        console.error(err);
        alert("Speed test failed — check console for details.");
      }
      startBtn.disabled = false;
            startBtn.textContent = "테스트 다시 시작";
    }

    async function measurePing(url) {
      try {
        const cacheBuster = `${url}?cache=${Date.now()}`;
        const t0 = performance.now();
        await fetch(cacheBuster, { method: "HEAD", mode: "no-cors" });
        return performance.now() - t0;
      } catch {
        return 999;
      }
    }

    async function measureDownload(element) {
      let bytes = 0;
      const tStart = performance.now();
      const testDuration = 8000; // 8 seconds
      for (const size of DOWNLOAD_SIZES) {
        if (performance.now() - tStart > testDuration) break;
        const url = `https://speed.cloudflare.com/__down?bytes=${size}&_=${Date.now()}`;
        try {
          const res = await fetch(url);
          await res.arrayBuffer();
          bytes += size;
          const tElapsed = (performance.now() - tStart) / 1000;
          const speed = tElapsed === 0 ? 0 : (bytes * 8) / tElapsed / 1e6;
          element.textContent = speed.toFixed(1);
        } catch (e) {
          console.warn(`Download test failed for size ${size}`, e);
          break;
        }
      }
      const tFinal = (performance.now() - tStart) / 1000;
      return tFinal === 0 ? 0 : (bytes * 8) / tFinal / 1e6;
    }

    async function measureUpload(element) {
      const blob = new Blob([crypto.getRandomValues(new Uint8Array(UPLOAD_SIZE))], { type: 'text/plain' });
      const tStart = performance.now();
      let bytes = 0;
      const testDuration = 8000;
      while (performance.now() - tStart < testDuration) {
        try {
          const response = await fetch(`https://speed.cloudflare.com/__up?_=${Date.now()}`, {
            method: "POST",
            body: blob,
          });
          await response.text();
          bytes += UPLOAD_SIZE;
          const tElapsed = (performance.now() - tStart) / 1000;
          const speed = tElapsed === 0 ? 0 : (bytes * 8) / tElapsed / 1e6;
          element.textContent = speed.toFixed(1);
        } catch (e) {
          console.warn("Upload test failed", e);
          break;
        }
      }
      const tFinal = (performance.now() - tStart) / 1000;
      return tFinal === 0 ? 0 : (bytes * 8) / tFinal / 1e6;
    }
  </script>
  <script src="../js/language-modal.js"></script>
  <script src="../js/settings.js"></script>
</body>
</html>
